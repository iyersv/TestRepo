import pandas as pd
import time
import csv
import pygeohash
import mzgeohash
#import kafka_producer

from cassandra.cluster import Cluster
from kafka import KafkaProducer

import  timeit

def push_to_pandas(filename):
	cluster = Cluster()
        session = cluster.connect('xweather')

	df = pd.read_csv(filename)
	df1= df[['id','lat','lon','src','elev','timezone','tzoffset']].drop_duplicates()
	df1.src.fillna('NA')
	# Adding Geohash Id
	df1['geohash_id']=df.apply(lambda row:pygeohash.encode(row['lat'],row['lon']),axis=1)
	query="insert into weather_stations(geohash_id,station_id,elev,geohash_sub,lat,lon,source,timezone,tzoffset,neighbors) values(?,?,?,?,?,?,?,?,?,?)"
	prepared = session.prepare(query)

 	# Prepare Insert for the neighbor_map_stations table
	query2 ="insert into neighbor_map_stations(geohash_sub,station_id,geohash_id,lat_long,neighbors) values (?,?,?,?,?)"
	prepared2=session.prepare(query2)
	
	#Now loop through the Dataframe

	for row in df1.itertuples():
	  k=tuple(row)
	  maplist=mzgeohash.neighbors(row[8][:4]).values()
	  
	  bound=prepared.bind((row[8],row[1],(row[5]),row[8][:4],(row[2]),(row[3]),repr(row[4]),row[6],repr(row[7]),maplist))
	  session.execute_async(bound)

	  bound2=prepared2.bind((row[8][:4],row[1],row[8],list((str(row[2]),str(row[3]))),maplist))
          session.execute_async(bound2)

	print('Completed insert into weather stations')
	
	#Now to the facts
	#Remove the descriptive columns
	df.drop(df.columns[[1,2,3,4,5,6]],axis=1,inplace=True)
	
	#Unpivot the dataset
	df=pd.melt(df,id_vars=['id','timestamp','dateTime'])
	df=df.dropna()
	# Kafka it
	start_time = timeit.default_timer()
	ctr =0;
	producer = KafkaProducer(bootstrap_servers=['vm1:9092'])
	for row in df.itertuples():
	   k=list(row)
	   k=k[1:]
	   j= ','.join(str(x) for x in k)
	   future = producer.send('temp',j)
	   #kafka_producer.send_to_kafka('temp',j)
           ctr+=1
        print('Producer timing is ',timeit.default_timer() - start_time,'Rows:',ctr)
	producer.flush()
	producer.close()

#Main function
push_to_pandas('allstations.csv')

